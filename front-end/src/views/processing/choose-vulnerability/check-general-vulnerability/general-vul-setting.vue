<template>
  <div id="main">
    <div class="container" style="margin-bottom: 5%">
      <h2>General Vulnerability Setting</h2>
    </div>
      <div class="row">
        <div class="col-3">Vulnerability/CS-Property</div>
        <div class="col-7" >
            <div id="choose-section">
            <button id="choose-btn" class="btn btn-outline-dark" @click="toggleList()">Select Vulnerabilities</button>
            <div id="choose-list" v-show="showList">
            <div v-for="vul in list_vulnerabilities" :key="vul.id" >
              <input type="checkbox" :value="vul" v-model="selected_vuls" :id="vul.id+'-input'" @change="saveSelectedVuls"/>
              <label :for="vul.id+'-input'">{{vul.name}}</label>
            </div>
            </div>
            </div>
        </div>
        </div>
      <div class="container" v-if="selected_vuls.length > 0" id="chosen-section">
        <div v-for="vul in selected_vuls" :key="vul.id" class="chosen-vuls">
          <div class="row vul-name-holder">
            <div class="vul-name col-9" @click="toggleDesc(vul.id)">{{vul.name}} <span class="material-icons desc-toggle">remove</span></div>
            <div class="btn-container col-2"><button class="btn btn-light btn-sm" @click="deleteVul(vul.id)"><span class="material-icons-outlined">
clear
</span></button><button class="config-btn btn btn-outline-info btn-sm" @click="config(vul)">Configure</button></div>
          </div>
          <div class="row">
            <div class="col-9 vul-desc-holder"><div class="vul-desc hide-desc" :id="vul.id">{{vul.description}}</div></div>
          </div>
        </div>
      </div>
      
    <div id="btn-group">
        <button class="btn btn-primary btn-sm" @click="routing('save')">Save</button>
        <button class="btn btn-primary btn-sm" @click="routing('conf')" v-if="selected_vuls.length > 0">Configuration</button>
        <button class="btn btn-outline-secondary btn-sm" @click="routing('back')">Back</button>
      </div>
  </div>
</template>

<script>
import { GetVulnerabilities} from "../../../../services/data";
import { GetSmartContractFunctionInfor} from "../../../../services/data";
export default {
  data() {
    return {
      list_vulnerabilities: [],
      chosen: '',
      selected_vuls: [],
      showList: false,
      selected_scs: [],

    };
  },
  methods: {
    saveSelectedVuls(){
      this.$store.commit("data/SetSelectedVulnerbility", this.selected_vuls)
      var scs = this.$store.getters["data/GetSelectedSC"]
      var info = GetSmartContractFunctionInfor(scs)
      for(let i = 0; i<scs.length; i++){
        var id = scs[i].id
        this.$store.commit(
                        "data/NewSCSelectedInfor",
                        {sc_id: id, sc_info: info[id]});
      }
      // console.log(this.$store.getters["data/GetSCSelectedInfor"])
      // console.log(this.$store.getters["data/GetSelectedVulnerbility"])
    },
    config(vul){
      this.$store.commit("data/SetConfigVul", vul);
      this.routing("conf")
    },
    deleteVul(vulid){
      for (var i=0; i<this.selected_vuls.length; i++) {
        if (this.selected_vuls[i].id == vulid) {
            this.selected_vuls.splice(i, 1);
            break
        }
      }
    },
    toggleDesc(vulid){
      var elem = document.getElementById(vulid)
        elem.classList.toggle("hide-desc");
    },
    toggleList(){
      this.showList = !this.showList
    },
    routing(param) {
      if (param == "back") {
        this.$store.commit("data/SetFourthStepViews","property-coptions")
        this.$emit("changeView",1)
      }
      if (param == "conf") {
        if(!(this.$store.getters["data/GetConfigVul"].id)) this.$store.commit("data/SetConfigVul", this.selected_vuls[0]);
        if(this.$store.getters["data/GetFourthStepViewsList"].length == 2){
          this.$store.commit("data/UpdateFourthStepViewsList",{name:"vulcon-select-els"});
        }
        this.$store.commit("data/SetFourthStepViews","vulcon-select-els")
        this.$emit("changeView",3)
      }
      if (param == "save") {
        this.$store.commit("data/SetSelectedVulnerbility", this.selected_vuls)
        this.$store.commit("data/SetFourthStepViews","property-coptions")
        this.$emit("changeView",1)
      }
      this.$emit("cap",'st3','hello')
    },
  },
  mounted(){
      this.list_vulnerabilities = GetVulnerabilities()
      this.selected_vuls = this.$store.getters["data/GetSelectedVulnerbility"];
      this.selected_scs = this.$store.getters["data/GetSelectedSC"]
  },
};
</script>

<style scoped>
#main{
  width: 1000px;
  margin: auto;
}
div{
  text-align: center;
}
.col-4{
  text-align: left;
}
#description_box {
  text-align: left;
}
.form-control {
  height: 300px;
  overflow: auto;
}
.row {
  margin: 2% 0%;
  text-align: left;
}
select {
  width: 100%;
  margin: 0;
}
#btn-group button{
  margin: 20px;
  width: 100px;
}
/* Choose Section */
#choose-section{
  width: 100%;
}

#choose-btn{
  width: 100%;
  text-align: left;
}
#choose-list{
  position: absolute;
  padding: 20px;
  background-color: white;
  border: solid 1px gray;
  max-height: 350px;
  overflow: auto;
}
#choose-list div{
  text-align: left;
  cursor: pointer;
  padding: 10px;
}
#choose-list div:hover{
  background-color: lightgray;
}
#choose-list input[type=checkbox]{
  cursor: pointer;
  transform: scale(1.3);
  margin-right: 7px;
}
label{
  cursor: pointer;
}
/* Chosen Section */
#chosen-section{
  margin: auto;
  margin-top: 50px;
  border-radius: 5px;
  width: 80%;
  padding: 0;
  height: 45vh;
  overflow: auto;
}
#chosen-section .row, #chosen-section .vul-desc-holder{
  margin: 0;
  padding: 0;
}
.chosen-vuls div{
  text-align: left;
}
.vul-name-holder{
  height: auto;
  margin: 0;
  padding: 0;
}
.vul-name{
  cursor: pointer;
  background-color: #e6efff;
  padding: 5px 10px;
  padding-top: 7px;
  padding-bottom: 5px;
  border: none;
  border-bottom: 1px lightgray solid;
}
.vul-desc{
  padding: 10px;
  padding-top: 10px;
  padding-bottom: 18px;
  border-left: 1px lightgray solid;
  border-right: 1px lightgray solid;
  margin: 0;
}
.material-icons, .material-icons-outlined{
  font-family: 'Material Icons';
}
.desc-toggle{
  float: right;
}
.hide-desc{
  display: none;
}
.config-btn{
  margin: auto;
}
.btn-container{
  padding: 5px 10px;
}
[class*="col-"] {
  display: inline;
}
@media only screen and (max-width: 768px){
  [class*="col-"] {
  width: 100%;
}
.row{
  margin: 10% 0 10% 0;
}
h1, h2{
  font-size: 150%;
}
}
</style>